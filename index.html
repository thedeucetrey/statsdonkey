<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StatsDonkey — R11</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--fg:#e5e7eb;--mut:#94a3b8;--acc:#4ade80;--line:#1f2937;--pad:14px;--rad:16px}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:var(--pad);box-shadow:0 8px 24px rgba(0,0,0,.25);margin-bottom:var(--pad)}
.hidden{display:none!important} .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select{width:100%;background:#0b1220;color:var(--fg);border:1px solid #334155;border-radius:12px;padding:12px}
label{font-size:12px;color:#cbd5e1;display:block;margin-bottom:4px}
.btn{background:var(--acc);color:#06220f;border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
.btn.outline{background:transparent;color:var(--acc);border:1px solid var(--acc)} .btn.small{padding:8px 10px;font-size:12px}
.small{font-size:12px;color:var(--mut)}
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
.table thead th{position:sticky;top:0;background:var(--card);z-index:1}
.table th.sort{cursor:pointer}
.hr{border-top:1px solid var(--line);opacity:.6;margin:14px 0}
.scroll{overflow:auto;border:1px solid var(--line);border-radius:12px;padding:6px}
.scroll.roster{max-height:50vh} .scroll.stats{max-height:50vh}

.cal-header{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:8px}
.cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
.cell{background:#0b1326;border:1px solid var(--line);border-radius:12px;min-height:84px;padding:6px}
.cell.head{background:transparent;border:none;text-align:center;font-weight:700}
.cell.blank{background:transparent;border:none}
.cell .date{font-weight:800;color:#cbd5e1;margin-bottom:6px}
.cell .events{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:4px}
.cell .events li{font-size:12px;color:#e5e7eb;background:#0f172a;border:1px solid #1f2937;padding:4px 6px;border-radius:8px}

nav{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.9);border-bottom:1px solid var(--line);backdrop-filter:blur(6px)}
nav .wrap{display:flex;align-items:center;gap:10px;max-width:980px;margin:0 auto;padding:10px 16px}
.brand{font-weight:800;color:#4ade80} .spacer{flex:1}
#debug{position:fixed;right:8px;bottom:8px;background:#0b1326;border:1px solid #1f2937;border-radius:10px;padding:6px 8px;font-size:12px;opacity:.9}
.bad{color:#f87171}
.tag{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}
.field{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-width:320px}
.zone{border:1px dashed #334155;border-radius:10px;padding:14px;text-align:center;cursor:pointer}
.zone.active{outline:2px solid var(--acc)}
.scorebug{position:sticky;top:52px;z-index:19;background:#0b1326;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
</style>
</head>
<body>
<nav>
  <div class="wrap">
    <div class="brand">StatsDonkey</div>
    <div class="spacer"></div>
    <span class="small">BUILD R11</span>
    <button id="btn-logout" class="btn outline small hidden" type="button" style="margin-left:8px">Logout</button>
  </div>
</nav>

<main class="container">
  <!-- LOGIN -->
  <section id="view-login" class="card">
    <h2>Team Login</h2>
    <p class="small">Enter <b>Team</b> and <b>Password</b>. First login creates the team. Any device with the same team+password loads the same data.</p>
    <div class="row">
      <input id="team-id" class="input" placeholder="Team (e.g., Argos)" autocomplete="off" autocapitalize="none" spellcheck="false" style="max-width:280px"/>
      <input id="team-pass" class="input" type="password" placeholder="Password" autocomplete="new-password" style="max-width:220px"/>
      <button id="btn-login" class="btn" type="button">Log in</button>
    </div>
    <div id="login-error" class="small bad" style="margin-top:6px"></div>
  </section>

  <!-- TEAM PROFILE -->
  <section id="sec-team" class="card hidden">
    <h2>1) Team profile</h2>
    <div class="row">
      <input id="team-name" class="input" placeholder="Team name" style="min-width:260px"/>
      <input id="team-logo" type="file" accept="image/*" class="input" style="min-width:260px"/>
      <button id="btn-save-team" class="btn" type="button">Save profile</button>
    </div>
    <div class="small">Logo preview:</div>
    <img id="logo-preview" alt="logo" style="max-width:160px;max-height:160px;border:1px solid var(--line);border-radius:12px;display:none"/>
  </section>

  <!-- ROSTER -->
  <section id="sec-roster" class="card hidden">
    <h2>2) Roster</h2>
    <!-- NEW PLAYER FORM -->
    <div class="row">
      <div style="max-width:160px;flex:1 1 160px"><label for="pf-first">First</label><input id="pf-first" class="input" placeholder="First"></div>
      <div style="max-width:160px;flex:1 1 160px"><label for="pf-last">Last</label><input id="pf-last" class="input" placeholder="Last"></div>
      <div style="max-width:170px;flex:1 1 170px"><label for="pf-dob">DOB</label><input id="pf-dob" class="input" type="date" aria-label="DOB" placeholder="YYYY-MM-DD"></div>
      <div style="max-width:240px;flex:1 1 240px"><label for="pf-pos">Position(s)</label><input id="pf-pos" class="input" placeholder="e.g., SS, 3B, OF"></div>
      <div style="max-width:90px;flex:1 1 90px"><label for="pf-num">#</label><input id="pf-num" class="input" type="number" placeholder="#"></div>
    </div>
    <div class="row">
      <div style="max-width:180px;flex:1 1 180px"><label for="pf-nsa">NSA rank</label><input id="pf-nsa" class="input" placeholder="NSA"></div>
      <div style="max-width:180px;flex:1 1 180px"><label for="pf-spn">SPN rank</label><input id="pf-spn" class="input" placeholder="SPN"></div>
      <button id="btn-add-player" class="btn" type="button">Add New Player</button>
      <span id="pf-err" class="small bad"></span>
    </div>

    <div class="hr"></div>

    <!-- SEARCH EXISTING -->
    <div class="row">
      <div style="max-width:360px;flex:1 1 360px"><label for="srch-name">Search existing players</label><input id="srch-name" class="input" placeholder="type a name…"></div>
      <div style="max-width:180px;flex:1 1 180px"><label for="srch-dob">DOB (optional)</label><input id="srch-dob" class="input" type="date"></div>
      <div style="max-width:120px;flex:1 1 120px"><label for="srch-num"># for team</label><input id="srch-num" class="input" type="number" placeholder="#"></div>
      <div style="max-width:220px;flex:1 1 220px"><label for="srch-pos">Position(s) for team</label><input id="srch-pos" class="input" placeholder="e.g., OF"></div>
      <button id="btn-search" class="btn" type="button" style="align-self:flex-end">Search</button>
    </div>
    <div id="srch-results" class="small" style="margin-top:6px"></div>

    <div id="roster-count" class="small" style="margin-top:10px"></div>
    <div class="scroll roster"><table class="table" id="tbl-roster"></table></div>
  </section>

  <!-- SCHEDULER -->
  <section id="sec-schedule" class="card hidden">
    <h2>3) Scheduler</h2>
    <div class="row">
      <input id="sch-date" class="input" type="date" style="max-width:170px"/>
      <input id="sch-time" class="input" type="time" style="max-width:130px"/>
      <input id="sch-field" class="input" placeholder="Field" style="max-width:180px"/>
      <input id="sch-comp" class="input" placeholder="League/Tournament" style="max-width:220px"/>
    </div>
    <div class="row">
      <input id="sch-home" class="input" placeholder="Home team" style="max-width:220px"/>
      <input id="sch-away" class="input" placeholder="Away team" style="max-width:220px"/>
      <button id="btn-sch-add" class="btn" type="button">Add game</button>
    </div>
  </section>

  <!-- CALENDAR -->
  <section id="sec-calendar" class="card hidden">
    <h2>4) Calendar</h2>
    <div class="cal-header">
      <button id="prev-month" class="btn outline small" type="button">◀</button>
      <h3 id="cal-title" style="margin:0 10px"></h3>
      <button id="next-month" class="btn outline small" type="button">▶</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </section>

  <!-- STATS -->
  <section id="sec-stats" class="card hidden">
    <h2>5) Player stats (global)</h2>
    <div class="scroll stats">
      <table class="table sortable" id="tbl-stats"></table>
    </div>
    <p class="small">Totals come from the player's global profile (across all teams).</p>
  </section>

  <!-- GAME SETUP + TRACKER -->
  <section id="sec-game" class="card hidden">
    <h2>6) Game setup & tracker</h2>

    <!-- Score bug -->
    <div class="scorebug" id="scorebug" style="display:none">
      <span id="bug-opp" class="tag">vs ?</span>
      <span id="bug-score" class="tag">0–0</span>
      <span id="bug-inning" class="tag">Top 1 • 0 out</span>
    </div>

    <!-- Create / Load -->
    <div class="row" style="margin-top:8px">
      <input id="g-date" class="input" type="date" style="max-width:170px"/>
      <input id="g-opp" class="input" placeholder="Opponent name" style="max-width:220px"/>
      <label style="display:flex;align-items:center;gap:8px"><input id="g-home" type="checkbox"/>Home?</label>
      <button id="btn-new-game" class="btn" type="button">Create new game</button>
      <select id="sel-game" class="input" style="max-width:280px"></select>
      <button id="btn-load-game" class="btn outline" type="button">Load</button>
    </div>

    <!-- Pregame: home lineup + defense -->
    <div class="hr"></div>
    <h3>Pregame — Home lineup & defense</h3>
    <div class="row">
      <div style="flex:1 1 420px;min-width:280px">
        <div class="small" style="margin-bottom:6px">Batting order (select from roster)</div>
        <div id="lineup-home"></div>
      </div>
      <div style="flex:1 1 420px;min-width:280px">
        <div class="small" style="margin-bottom:6px">Defense</div>
        <div id="defense-home"></div>
      </div>
    </div>

    <!-- Opponent roster + lineup -->
    <div class="hr"></div>
    <h3>Pregame — Opponent</h3>
    <div class="row">
      <div style="max-width:260px;flex:1 1 260px"><label for="opp-name">Name</label><input id="opp-name" class="input" placeholder="Opponent name"></div>
      <div style="max-width:200px;flex:1 1 200px"><label for="opp-add">Add player</label><input id="opp-add" class="input" placeholder="First Last"></div>
      <button id="btn-opp-add" class="btn" type="button" style="align-self:flex-end">Add</button>
    </div>
    <div class="row">
      <div style="flex:1 1 420px;min-width:280px">
        <div class="small" style="margin-bottom:6px">Opponent batting order</div>
        <div id="lineup-away"></div>
      </div>
      <div style="flex:1 1 420px;min-width:280px">
        <div class="small" style="margin-bottom:6px">Opponent defense</div>
        <div id="defense-away"></div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btn-save-pregame" class="btn" type="button">Save pregame</button>
      <span class="small" id="pregame-msg"></span>
    </div>

    <!-- Live At-Bat logger -->
    <div class="hr"></div>
    <h3>Live — At-bat logger</h3>
    <div class="row">
      <select id="ab-batting" class="input" style="max-width:140px">
        <option value="home">Home</option>
        <option value="away">Away</option>
      </select>
      <select id="ab-batter" class="input" style="max-width:240px"></select>
      <select id="ab-result" class="input" style="max-width:180px">
        <option value="1B">Single</option><option value="2B">Double</option><option value="3B">Triple</option>
        <option value="HR">Home Run</option><option value="BB">Walk</option><option value="K">Strikeout</option>
        <option value="GO">Groundout</option><option value="FO">Flyout</option><option value="ROE">Reach on Error</option>
        <option value="FC">Fielder's Choice</option><option value="SAC">Sacrifice</option>
      </select>
      <select id="ab-hard" class="input" style="max-width:160px">
        <option>Medium</option><option>Hard</option><option>Soft</option>
      </select>
      <input id="ab-runs" class="input" type="number" placeholder="Runs scored (0-4)" style="max-width:170px"/>
    </div>
    <div class="small" style="margin:6px 0 4px">Spray zone (click one)</div>
    <div class="field" id="spray">
      <div class="zone" data-zone="LF">LF</div><div class="zone" data-zone="LCF">LCF</div><div class="zone" data-zone="CF">CF</div>
      <div class="zone" data-zone="RCF">RCF</div><div class="zone" data-zone="RF">RF</div><div class="zone" data-zone="IF-L">IF-L</div>
      <div class="zone" data-zone="IF-C">IF-C</div><div class="zone" data-zone="IF-R">IF-R</div><div class="zone" data-zone="BUNT">BUNT</div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btn-record" class="btn" type="button">Record play</button>
      <button id="btn-undo" class="btn outline" type="button">Undo last</button>
      <span id="ab-msg" class="small"></span>
    </div>

    <!-- Box score -->
    <div class="hr"></div>
    <h3>Box score</h3>
    <div id="boxscore" class="scroll" style="max-height:40vh"></div>
  </section>
</main>

<div id="debug">status: <span id="dbg-status">boot</span></div>

<!-- Firebase (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, updateDoc,
    getDocs, query, orderBy, startAt, endAt, limit, arrayUnion, deleteField
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // === Your Firebase config ===
  const firebaseConfig = {
    apiKey: "AIzaSyD3uKx0mIPTMT0pkL1Dxi-cGZiEZoQG3AU",
    authDomain: "statsdonkey-c276c.firebaseapp.com",
    projectId: "statsdonkey-c276c",
    storageBucket: "statsdonkey-c276c.firebasestorage.app",
    messagingSenderId: "456849470787",
    appId: "1:456849470787:web:0479b3dc8ca976296c2bf6",
    measurementId: "G-T670NG1LYF"
  };

  const app = initializeApp(firebaseConfig);
  try { if (await analyticsSupported()) getAnalytics(app); } catch {}
  const db = getFirestore(app);

  // ---------- Utilities ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const setDbg = s => { const el = $('#dbg-status'); if (el) el.textContent = s; };
  function show(e){e&&e.classList.remove('hidden')} function hide(e){e&&e.classList.add('hidden')}
  function nameNorm(first,last){ return `${(first||'').trim().toLowerCase()} ${(last||'').trim().toLowerCase()}`.trim(); }
  async function sha256Hex(text){ const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  async function teamIdHash(team, pass){ return sha256Hex((team||'').trim().toLowerCase() + '|' + (pass||'')); }
  async function playerIdFor(first,last,dob){ return sha256Hex(`${(first||'').trim().toLowerCase()}|${(last||'').trim().toLowerCase()}|${(dob||'').trim()}`); }
  function csvToObjects(t){const rows=t.split(/\r?\n/).map(r=>r.split(',')).filter(r=>r.some(x=>x));if(!rows.length)return[];const H=rows[0].map(h=>h.toLowerCase());return rows.slice(1).map(r=>{const o={};for(let i=0;i<H.length;i++)o[H[i]]=(r[i]||'').replace(/^"|"$/g,'').trim();return o;});}

  // ---------- App state ----------
  let teamDocId = null, unsubTeam = null, unsubGame = null;
  let data = { team:{ name:'', logo:'' }, roster:[], schedule:[], stats:{} };
  let calCurrent = new Date();
  const playerCache = new Map();
  let currentGameId = null;
  let currentGame = null; // loaded game doc data

  // ---------- Team realtime ----------
  function startTeamListener(){
    stopTeamListener();
    unsubTeam = onSnapshot(doc(db, "teams", teamDocId), async snap=>{
      if (snap.exists()){
        data = snap.data();
        await preloadRosterPlayers();
        hydrateUI();
      }
    });
  }
  function stopTeamListener(){ if (unsubTeam){ unsubTeam(); unsubTeam=null; } }
  async function saveTeamDoc(patch){ await setDoc(doc(db, "teams", teamDocId), patch?patch:data, { merge:true }); }
  async function ensureTeamSeed(team){
    const ref = doc(db, "teams", teamDocId);
    const snap = await getDoc(ref);
    if (!snap.exists()) await setDoc(ref, { team:{ name: team, logo:'' }, roster:[], schedule:[], stats:{} }, { merge:true });
    else if (!snap.data().team?.name) await setDoc(ref, { team:{ name: team } }, { merge:true });
  }
  async function preloadRosterPlayers(){
    const ids = Array.from(new Set((data.roster||[]).map(r=>r.playerId).filter(Boolean)));
    await Promise.all(ids.map(async id=>{
      if (playerCache.has(id)) return;
      const snap = await getDoc(doc(db, "players", id));
      if (snap.exists()) playerCache.set(id, snap.data());
    }));
  }

  // ---------- UI boot ----------
  (function initUI(){
    // login
    $('#btn-login').onclick = async ()=>{
      const team = $('#team-id').value.trim();
      const pass = $('#team-pass').value;
      const err = $('#login-error'); err.textContent='';
      if (!team || !pass){ err.textContent='Enter team and password.'; return; }
      try{
        teamDocId = await teamIdHash(team, pass);
        await ensureTeamSeed(team);
        route(true); startTeamListener();
        setDbg('authless:ok');
        listGames(); // populate game selector
      }catch(e){ console.error(e); err.textContent='Login failed (config/rules).'; }
    };
    $('#btn-logout').onclick = ()=>{ stopTeamListener(); stopGameListener(); currentGameId=null; currentGame=null; route(false); };

    // team profile
    $('#btn-save-team').onclick = async ()=>{
      const name = $('#team-name').value.trim() || (data.team?.name || '');
      await saveTeamDoc({ team: { ...(data.team||{}), name } });
      alert('Profile saved');
    };
    $('#team-logo').onchange = (ev)=>{
      const f = ev.target.files && ev.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload=async()=>{ await saveTeamDoc({ team:{ ...(data.team||{}), logo:r.result } }); }; r.readAsDataURL(f);
    };

    // roster
    $('#btn-add-player').onclick = onAddPlayer;
    $('#btn-search').onclick = onSearchPlayers;

    // scheduler
    $('#btn-sch-add').onclick = async ()=>{
      const date=$('#sch-date').value, time=$('#sch-time').value, field=$('#sch-field').value.trim(), comp=$('#sch-comp').value.trim();
      const home=$('#sch-home').value.trim(), away=$('#sch-away').value.trim();
      if(!date || !home || !away) return alert('Date, Home, Away required');
      const id=(crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now());
      const schedule=[...(data.schedule||[]), { id, date, time, field, comp, home, away }];
      await saveTeamDoc({ schedule }); $('#sch-time').value=''; $('#sch-field').value=''; $('#sch-comp').value='';
      renderCalendar();
    };

    // game
    $('#btn-new-game').onclick = createNewGame;
    $('#btn-load-game').onclick = loadSelectedGame;
    $('#btn-opp-add').onclick = ()=> addOpponentPlayer($('#opp-add').value.trim());
    $('#btn-save-pregame').onclick = savePregame;
    $('#btn-record').onclick = recordPlay;
    $('#btn-undo').onclick = undoLast;

    // spray zones
    $$('#spray .zone').forEach(z=>z.onclick=()=>{ $$('#spray .zone').forEach(x=>x.classList.remove('active')); z.classList.add('active'); });

    setDbg('ready');
  })();

  // ---------- Routing & hydrate ----------
  function route(on){
    if(!on){
      show($('#view-login'));
      ['sec-team','sec-roster','sec-schedule','sec-calendar','sec-stats','sec-game'].forEach(id=>hide($('#'+id)));
      $('#btn-logout').classList.add('hidden'); return;
    }
    hide($('#view-login'));
    ['sec-team','sec-roster','sec-schedule','sec-calendar','sec-stats','sec-game'].forEach(id=>show($('#'+id)));
    $('#btn-logout').classList.remove('hidden');
    hydrateUI();
  }
  function hydrateUI(){
    // team
    $('#team-name').value = data.team?.name || '';
    const im=$('#logo-preview'); im.src = data.team?.logo || ''; im.style.display = data.team?.logo ? 'block':'none';
    // roster + stats + cal
    renderRoster(); renderStats(); renderCalendar();
    // pregame forms (lineup/defense builders)
    renderLineupBuilder('home', data.roster||[]);
    renderDefenseBuilder('home', data.roster||[]);
    renderLineupBuilder('away', (currentGame?.away?.roster||[]).map(n=>({first:n.split(' ')[0]||'',last:n.split(' ').slice(1).join(' ')||'',playerId:n})));
    renderDefenseBuilder('away', (currentGame?.away?.roster||[]).map(n=>({first:n,last:n,playerId:n})));
    updateScoreViews();
  }

  // ---------- Roster ----------
  async function onAddPlayer(){
    $('#pf-err').textContent='';
    const first=$('#pf-first').value.trim(), last=$('#pf-last').value.trim();
    const dob=$('#pf-dob').value; const positions=$('#pf-pos').value.split(/\s*,\s*/).filter(Boolean);
    const number=$('#pf-num').value?Number($('#pf-num').value):undefined;
    const nsa=$('#pf-nsa').value.trim(), spn=$('#pf-spn').value.trim();
    if(!first || !last || !dob){ $('#pf-err').textContent='First, Last, and DOB are required.'; return; }
    try{
      const pid = await playerIdFor(first,last,dob);
      if ((data.roster||[]).some(r=>r.playerId===pid)){ $('#pf-err').textContent='Player already on this roster.'; return; }
      const pRef = doc(db,"players",pid); const pSnap=await getDoc(pRef);
      if (!pSnap.exists()){
        await setDoc(pRef,{
          first,last,dob,nameNorm:nameNorm(first,last),ranks:{nsa,spn},
          stats:{PA:0,AB:0,H:0,"1B":0,"2B":0,"3B":0,HR:0,BB:0,K:0,AVG:"0.000",OBP:"0.000",SLG:"0.000",OPS:"0.000"},
          createdAt:new Date().toISOString()
        },{merge:true});
      }else{
        const cur=pSnap.data()||{}; const ranks={...(cur.ranks||{})}; if(nsa)ranks.nsa=nsa; if(spn)ranks.spn=spn;
        await setDoc(pRef,{ranks},{merge:true});
      }
      playerCache.set(pid,(await getDoc(pRef)).data());
      const roster=[...(data.roster||[]), { playerId:pid, first,last,dob, number, positions, ranks:{nsa,spn} }];
      await saveTeamDoc({ roster });
      ['pf-first','pf-last','pf-dob','pf-pos','pf-num','pf-nsa','pf-spn'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
    }catch(e){ console.error(e); $('#pf-err').textContent='Add failed.'; }
  }
  async function onSearchPlayers(){
    const term=$('#srch-name').value.trim().toLowerCase(); const dob=$('#srch-dob').value; const out=$('#srch-results'); out.innerHTML='';
    if(!term){ out.textContent='Enter a name to search.'; return; }
    try{
      const qy=query(collection(db,"players"), orderBy('nameNorm'), startAt(term), endAt(term+'\uf8ff'), limit(25));
      const snap=await getDocs(qy); let list=snap.docs.map(d=>({id:d.id,...d.data()})); if(dob) list=list.filter(r=>(r.dob||'')===dob);
      if(!list.length){ out.textContent='No matches.'; return; }
      const numDefault=$('#srch-num').value?Number($('#srch-num').value):undefined;
      const posDefault=$('#srch-pos').value.split(/\s*,\s*/).filter(Boolean);
      const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='6px 0';
      list.forEach(r=>{
        const li=document.createElement('li'); li.style.marginBottom='6px';
        const already=(data.roster||[]).some(x=>x.playerId===r.id);
        li.innerHTML=`
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div><b>${r.first||''} ${r.last||''}</b> — DOB: ${r.dob||''}</div>
            <div class="small">NSA: ${r.ranks?.nsa||'-'} | SPN: ${r.ranks?.spn||'-'}</div>
            ${already?'<span class="small" style="color:#34d399">Already on roster</span>':'<button class="btn small" data-add="'+r.id+'">Add to team</button>'}
          </div>`;
        ul.appendChild(li);
      });
      out.appendChild(ul);
      out.querySelectorAll('button[data-add]').forEach(btn=>{
        btn.onclick=async()=>{
          const pid=btn.getAttribute('data-add'); if((data.roster||[]).some(x=>x.playerId===pid)) return;
          const pSnap=await getDoc(doc(db,"players",pid)); if(!pSnap.exists()) return;
          const p=pSnap.data();
          const roster=[...(data.roster||[]), { playerId:pid, first:p.first||'', last:p.last||'', dob:p.dob||'', number:numDefault, positions:posDefault, ranks:{nsa:p.ranks?.nsa||'', spn:p.ranks?.spn||''} }];
          await saveTeamDoc({ roster }); playerCache.set(pid,p);
          btn.replaceWith((()=>{const t=document.createElement('span'); t.className='small'; t.style.color='#34d399'; t.textContent='Added'; return t; })());
        };
      });
    }catch(e){ console.error(e); out.textContent='Search failed.'; }
  }
  function renderRoster(){
    const rows=(data.roster||[]).map(p=>`<tr>
      <td>${p.first} ${p.last}</td><td>${p.number||''}</td><td>${(p.positions||[]).join(', ')}</td>
      <td>${p.dob||''}</td><td>${p.ranks?.nsa||''}</td><td>${p.ranks?.spn||''}</td>
      <td class="small">${p.playerId}</td>`).join('');
    $('#roster-count').textContent = data.roster?.length ? (data.roster.length + ' players') : 'No players';
    $('#tbl-roster').innerHTML='<thead><tr><th>Player</th><th>#</th><th>Positions</th><th>DOB</th><th>NSA</th><th>SPN</th><th>ID</th></tr></thead><tbody>'+rows+'</tbody>';
  }

  // ---------- Stats ----------
  function computeStatsRows(){
    return (data.roster||[]).map(r=>{
      const g=playerCache.get(r.playerId)||{}; const s=g.stats||{};
      return { Player:`${r.first} ${r.last}`.trim(), PA:s.PA||0, AB:s.AB||0, H:s.H||0, '1B':s['1B']||0, '2B':s['2B']||0, '3B':s['3B']||0, HR:s.HR||0, BB:s.BB||0, K:s.K||0, AVG:s.AVG||'0.000', OBP:s.OBP||'0.000', SLG:s.SLG||'0.000', OPS:s.OPS||'0.000' };
    });
  }
  let sortKey='Player', sortDir='asc';
  function renderStats(){
    let rows=computeStatsRows();
    rows.sort((a,b)=>{const A=a[sortKey],B=b[sortKey];const num=!isNaN(parseFloat(A))&&!isNaN(parseFloat(B));return (sortDir==='asc'?1:-1)*(num?(parseFloat(A)-parseFloat(B)):String(A).localeCompare(String(B)));});
    const headers=['Player','PA','AB','H','1B','2B','3B','HR','BB','K','AVG','OBP','SLG','OPS'];
    const thead='<thead><tr>'+headers.map(h=>`<th class="sort" data-key="${h}">${h}</th>`).join('')+'</tr></thead>';
    const tbody='<tbody>'+rows.map(r=>'<tr>'+headers.map(h=>`<td>${r[h]}</td>`).join('')+'</tr>').join('')+'</tbody>';
    $('#tbl-stats').innerHTML=thead+tbody;
    $$('#tbl-stats th.sort').forEach(th=>th.addEventListener('click',()=>{const key=th.dataset.key;if(sortKey===key) sortDir=(sortDir==='asc'?'desc':'asc'); else{sortKey=key;sortDir='asc';} renderStats();}));
  }

  // ---------- Calendar ----------
  function renderCalendar(){
    const m0=new Date(calCurrent.getFullYear(),calCurrent.getMonth(),1);
    const m1=new Date(calCurrent.getFullYear(),calCurrent.getMonth()+1,0);
    $('#cal-title').textContent=m0.toLocaleString(undefined,{month:'long',year:'numeric'});
    const first=m0.getDay(),days=m1.getDate(); const grid=$('#cal-grid'); grid.innerHTML='';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const h=document.createElement('div'); h.className='cell head'; h.textContent=d; grid.appendChild(h);});
    for(let i=0;i<first;i++){const b=document.createElement('div'); b.className='cell blank'; grid.appendChild(b);}
    for(let day=1; day<=days; day++){
      const cell=document.createElement('div'); cell.className='cell';
      const ds=`${m0.getFullYear()}-${String(m0.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const head=document.createElement('div'); head.className='date'; head.textContent=day; cell.appendChild(head);
      const ul=document.createElement('ul'); ul.className='events';
      (data.schedule||[]).filter(g=>String(g.date)===ds).forEach(g=>{
        const li=document.createElement('li'); li.textContent=`${g.time||''} ${g.home||'Home'} vs ${g.away||'Away'}${g.field?(' @ '+g.field):''}${g.comp?(' — '+g.comp):''}`.trim(); ul.appendChild(li);
      });
      cell.appendChild(ul); grid.appendChild(cell);
    }
  }

  // ---------- Game: create/load ----------
  async function listGames(){
    const sel=$('#sel-game'); sel.innerHTML=''; // list recent 15 by createdAt desc
    const sub=collection(doc(db,"teams",teamDocId),"games"); const qy=query(sub, orderBy('meta.createdAt','desc'), limit(15));
    const snap=await getDocs(qy);
    snap.forEach(d=>{
      const g=d.data(); const o=document.createElement('option');
      o.value=d.id; o.textContent=`${g.meta?.date||'?'} — ${g.meta?.opponent||'?'} (${g.meta?.isHome?'Home':'Away'})`;
      sel.appendChild(o);
    });
  }

  function stopGameListener(){ if (unsubGame){ unsubGame(); unsubGame=null; } }
  function startGameListener(gameId){
    stopGameListener();
    const ref=doc(db,"teams",teamDocId,"games",gameId);
    unsubGame=onSnapshot(ref,snap=>{
      if(!snap.exists()) return;
      currentGame=snap.data(); currentGameId=gameId;
      $('#scorebug').style.display='inline-flex';
      hydrateUI();
      updateScoreViews();
      populateAtBatControls();
    });
  }

  async function createNewGame(){
    const date=$('#g-date').value || new Date().toISOString().slice(0,10);
    const opp=$('#g-opp').value.trim() || 'Opponent';
    const isHome=$('#g-home').checked;
    const id = Date.now().toString(36);
    const ref=doc(db,"teams",teamDocId,"games",id);
    const homeLineup=(data.roster||[]).slice(0,10).map(r=>r.playerId);
    const defTemplate = { P:null,C:null,'1B':null,'2B':null,'3B':null,SS:null,LF:null,LCF:null,RCF:null,RF:null };
    const seed={
      meta:{ date, opponent:opp, isHome, status:'pregame', createdAt:new Date().toISOString() },
      home:{ lineup:homeLineup, defense:{...defTemplate}, batterIndex:0, name:data.team?.name||'Home' },
      away:{ roster:[], lineup:[], defense:{...defTemplate}, batterIndex:0, name:opp },
      inning:{ half:'top', number:1, outs:0 },
      score:{ home:0, away:0, byInning:{} },
      plays:[]
    };
    await setDoc(ref,seed);
    startGameListener(id);
    await listGames();
    $('#opp-name').value=opp;
  }

  async function loadSelectedGame(){
    const id=$('#sel-game').value; if(!id) return;
    startGameListener(id);
  }

  // ---------- Game: pregame builders ----------
  const POSITIONS=['P','C','1B','2B','3B','SS','LF','LCF','RCF','RF'];

  function renderLineupBuilder(side, rosterLike){
    const host = $('#lineup-'+side); host.innerHTML='';
    const arr = (side==='home') ? (currentGame?.home?.lineup || (data.roster||[]).slice(0,10).map(r=>r.playerId))
                                 : (currentGame?.away?.lineup || []);
    const options = rosterLike.map(p=>({id:p.playerId || `${p.first} ${p.last}`.trim(), name:(p.first&&p.last)?`${p.first} ${p.last}`:p.playerId||''}));
    for(let i=0;i<10;i++){
      const wrap=document.createElement('div'); wrap.className='row';
      const sel=document.createElement('select'); sel.className='input'; sel.style.maxWidth='320px';
      sel.innerHTML='<option value="">— empty —</option>'+options.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      sel.value = arr[i] || '';
      sel.onchange=async()=>{
        await setDoc(doc(db,"teams",teamDocId,"games",currentGameId), {[side]:{...(currentGame?.[side]||{}), lineup: Object.assign([], arr, {[i]:sel.value})}}, {merge:true});
      };
      const lab=document.createElement('div'); lab.className='small'; lab.textContent=`${i+1}`;
      wrap.appendChild(lab); wrap.appendChild(sel); host.appendChild(wrap);
    }
  }

  function renderDefenseBuilder(side, rosterLike){
    const host=$('#defense-'+side); host.innerHTML='';
    const def = currentGame?.[side]?.defense || {};
    const options = rosterLike.map(p=>({id:p.playerId || `${p.first} ${p.last}`.trim(), name:(p.first&&p.last)?`${p.first} ${p.last}`:p.playerId||''}));
    POSITIONS.forEach(pos=>{
      const row=document.createElement('div'); row.className='row';
      const lab=document.createElement('div'); lab.className='small'; lab.style.width='46px'; lab.textContent=pos;
      const sel=document.createElement('select'); sel.className='input'; sel.style.maxWidth='320px';
      sel.innerHTML='<option value="">— empty —</option>'+options.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      sel.value=def[pos]||'';
      sel.onchange=async()=>{
        const patch={}; patch[`${side}.defense.${pos}`]=sel.value||null;
        await updateDoc(doc(db,"teams",teamDocId,"games",currentGameId), patch);
      };
      row.appendChild(lab); row.appendChild(sel); host.appendChild(row);
    });
  }

  async function addOpponentPlayer(fullname){
    if(!currentGameId || !fullname) return;
    const list=[...((currentGame?.away?.roster)||[])]; list.push(fullname);
    await setDoc(doc(db,"teams",teamDocId,"games",currentGameId), { away:{ ...(currentGame?.away||{}), roster:list } }, {merge:true});
    renderLineupBuilder('away', list.map(n=>({first:n.split(' ')[0]||'',last:n.split(' ').slice(1).join(' ')||'',playerId:n})));
    $('#opp-add').value='';
  }

  async function savePregame(){
    if(!currentGameId) return;
    const opp = $('#opp-name').value.trim() || currentGame?.meta?.opponent || 'Opponent';
    await setDoc(doc(db,"teams",teamDocId,"games",currentGameId), { meta:{ ...(currentGame?.meta||{}), opponent:opp, status:'live' } }, {merge:true});
    $('#pregame-msg').textContent='Saved. Game is LIVE.';
    setTimeout(()=>$('#pregame-msg').textContent='',2000);
  }

  // ---------- Game: live at-bat ----------
  function populateAtBatControls(){
    if(!currentGame) return;
    $('#ab-batting').value = currentGame.inning?.half==='top' ? 'away' : 'home';
    const side = $('#ab-batting').value;
    const lineup = currentGame?.[side]?.lineup || [];
    const sel = $('#ab-batter'); sel.innerHTML='';
    lineup.forEach(pid=>{
      const name = (side==='home')
        ? (data.roster||[]).find(r=>r.playerId===pid)?.first + ' ' + (data.roster||[]).find(r=>r.playerId===pid)?.last
        : pid; // opponent lineup is free text ids
      const opt=document.createElement('option'); opt.value=pid; opt.textContent=name||pid; sel.appendChild(opt);
    });
    updateScoreViews();
  }

  function computeScore(plays){
    const score={home:0,away:0, byInning:{}};
    (plays||[]).forEach(p=>{
      const inn=p.inning||1, half=p.half||'top'; const side=p.batting||'home';
      const runs = Number(p.runs||0)||0;
      score[side]+=runs;
      if(!score.byInning[inn]) score.byInning[inn]={home:0,away:0};
      score.byInning[inn][side]+=runs;
    });
    return score;
  }

  function updateScoreViews(){
    if(!currentGame) return;
    const score = computeScore(currentGame.plays||[]);
    const opp = currentGame.meta?.opponent||'?';
    const half = currentGame.inning?.half==='top'?'Top':'Bot';
    const outs = currentGame.inning?.outs||0;
    $('#bug-opp').textContent = (currentGame.meta?.isHome ? `vs ${opp}` : `@ ${opp}`);
    $('#bug-score').textContent = `${score.home}–${score.away}`;
    $('#bug-inning').textContent = `${half} ${currentGame.inning?.number||1} • ${outs} out`;
    // boxscore
    const maxInning = Math.max( ...[1, ...Object.keys(score.byInning).map(n=>Number(n)||1) ] );
    let html = '<table class="table"><thead><tr><th></th>';
    for(let i=1;i<=maxInning;i++) html += `<th>${i}</th>`;
    html += '<th>R</th></tr></thead><tbody>';
    const row = (name,side)=>{ let t=`<tr><td>${name}</td>`; for(let i=1;i<=maxInning;i++){ t+=`<td>${(score.byInning[i]?.[side]||0)}</td>`; } t+=`<td>${score[side]}</td></tr>`; return t; };
    html += row(currentGame.home?.name||'Home','home');
    html += row(currentGame.away?.name||'Away','away');
    html += '</tbody></table>';
    $('#boxscore').innerHTML = html;
  }

  async function recordPlay(){
    if(!currentGameId) return;
    const batting = $('#ab-batting').value; const batter = $('#ab-batter').value || 'Unknown';
    const result = $('#ab-result').value; const hard = $('#ab-hard').value;
    const runs = Number($('#ab-runs').value||0)||0;
    const activeZone = ($$('#spray .zone').find(z=>z.classList.contains('active'))?.dataset?.zone)||'';
    const inn = currentGame.inning?.number||1; const half = currentGame.inning?.half||'top';
    const timestamp = new Date().toISOString();
    const play = { ts:timestamp, batting, batter, result, hard, zone:activeZone, runs, inning:inn, half };
    const ref=doc(db,"teams",teamDocId,"games",currentGameId);
    await updateDoc(ref, { plays: arrayUnion(play) });
    // advance batter index (simple)
    const side = batting; const len = (currentGame?.[side]?.lineup||[]).length||0;
    const nextIndex = len ? (((currentGame?.[side]?.batterIndex||0)+1)%len) : 0;
    await setDoc(ref, { [side]:{ ...(currentGame?.[side]||{}), batterIndex: nextIndex } }, {merge:true});
    $('#ab-msg').textContent='Recorded'; setTimeout(()=>$('#ab-msg').textContent='',1200);
  }

  async function undoLast(){
    // simple undo: reload doc, drop last play, write whole plays array back
    if(!currentGameId) return; const ref=doc(db,"teams",teamDocId,"games",currentGameId);
    const snap=await getDoc(ref); if(!snap.exists()) return;
    const plays=[...(snap.data().plays||[])]; plays.pop();
    await setDoc(ref,{plays},{merge:true});
  }

</script>

<noscript><div style="background:#fee2e2;color:#7f1d1d;padding:12px;margin:12px;border-radius:8px">
JavaScript is disabled. Enable it to use StatsDonkey.
</div></noscript>
</body>
</html>
