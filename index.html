<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StatsDonkey — R12</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--fg:#e5e7eb;--mut:#94a3b8;--acc:#4ade80;--line:#1f2937;--pad:14px;--rad:16px}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:980px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:var(--pad);box-shadow:0 8px 24px rgba(0,0,0,.25);margin-bottom:var(--pad)}
.hidden{display:none!important} .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,select{width:100%;background:#0b1220;color:var(--fg);border:1px solid #334155;border-radius:12px;padding:12px}
label{font-size:12px;color:#cbd5e1;display:block;margin-bottom:4px}
.btn{background:var(--acc);color:#06220f;border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
.btn.outline{background:transparent;color:var(--acc);border:1px solid var(--acc)} .btn.small{padding:8px 10px;font-size:12px}
.small{font-size:12px;color:var(--mut)}
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
.table thead th{position:sticky;top:0;background:var(--card);z-index:1}
.table th.sort{cursor:pointer}
.hr{border-top:1px solid var(--line);opacity:.6;margin:14px 0}
.scroll{overflow:auto;border:1px solid var(--line);border-radius:12px;padding:6px}
.scroll.roster{max-height:50vh} .scroll.stats{max-height:50vh}

.cal-header{display:flex;align-items:center;gap:8px;justify-content:center;margin-bottom:8px}
.cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:6px}
.cell{background:#0b1326;border:1px solid var(--line);border-radius:12px;min-height:84px;padding:6px}
.cell.head{background:transparent;border:none;text-align:center;font-weight:700}
.cell.blank{background:transparent;border:none}
.cell .date{font-weight:800;color:#cbd5e1;margin-bottom:6px}
.cell .events{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:4px}
.cell .events li{font-size:12px;color:#e5e7eb;background:#0f172a;border:1px solid #1f2937;padding:4px 6px;border-radius:8px;cursor:pointer}
.cell .events li:hover{outline:1px solid #334155}

nav{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.9);border-bottom:1px solid var(--line);backdrop-filter:blur(6px)}
nav .wrap{display:flex;align-items:center;gap:10px;max-width:980px;margin:0 auto;padding:10px 16px}
.brand{font-weight:800;color:#4ade80} .spacer{flex:1}
#debug{position:fixed;right:8px;bottom:8px;background:#0b1326;border:1px solid #1f2937;border-radius:10px;padding:6px 8px;font-size:12px;opacity:.9}
.bad{color:#f87171}

.scorebug{position:sticky;top:52px;z-index:19;background:#0b1326;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
.tag{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px}

#diamond-wrap{display:flex;gap:16px;flex-wrap:wrap}
#diamond{background:#0b1326;border:1px solid #1f2937;border-radius:12px;padding:8px;cursor:crosshair}
.basegrid{display:grid;grid-template-columns:repeat(3,100px);grid-auto-rows:76px;gap:10px}
.base{border:1px solid #334155;border-radius:12px;padding:8px}
.base .who{display:block;margin-top:6px;font-size:12px;color:#e5e7eb}
.base.hot{outline:2px solid var(--acc)}
.runners{display:flex;gap:6px;flex-wrap:wrap}
.runner{border:1px solid #334155;border-radius:999px;padding:6px 10px;background:#0f172a;cursor:pointer}
.runner.sel{outline:2px solid var(--acc)}

#modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
.modal-card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;max-width:560px;width:100%;padding:14px}
</style>
</head>
<body>
<nav>
  <div class="wrap">
    <div class="brand">StatsDonkey</div>
    <div class="spacer"></div>
    <span class="small">BUILD R12</span>
    <button id="btn-logout" class="btn outline small hidden" type="button" style="margin-left:8px">Logout</button>
  </div>
</nav>

<main class="container">
  <!-- LOGIN -->
  <section id="view-login" class="card">
    <h2>Team Login</h2>
    <p class="small">Enter <b>Team</b> and <b>Password</b>. First login creates the team. Any device with the same team+password loads the same data.</p>
    <div class="row">
      <input id="team-id" class="input" placeholder="Team (e.g., Argos)" autocomplete="off" autocapitalize="none" spellcheck="false" style="max-width:280px"/>
      <input id="team-pass" class="input" type="password" placeholder="Password" autocomplete="new-password" style="max-width:220px"/>
      <button id="btn-login" class="btn" type="button">Log in</button>
    </div>
    <div id="login-error" class="small bad" style="margin-top:6px"></div>
  </section>

  <!-- TEAM PROFILE -->
  <section id="sec-team" class="card hidden">
    <h2>1) Team profile</h2>
    <div class="row">
      <input id="team-name" class="input" placeholder="Team name" style="min-width:260px"/>
      <input id="team-logo" type="file" accept="image/*" class="input" style="min-width:260px"/>
      <button id="btn-save-team" class="btn" type="button">Save profile</button>
    </div>
    <div class="small">Logo preview:</div>
    <img id="logo-preview" alt="logo" style="max-width:160px;max-height:160px;border:1px solid var(--line);border-radius:12px;display:none"/>
  </section>

  <!-- ROSTER -->
  <section id="sec-roster" class="card hidden">
    <h2>2) Roster</h2>
    <div class="row">
      <div style="max-width:160px;flex:1 1 160px"><label for="pf-first">First</label><input id="pf-first" class="input" placeholder="First"></div>
      <div style="max-width:160px;flex:1 1 160px"><label for="pf-last">Last</label><input id="pf-last" class="input" placeholder="Last"></div>
      <div style="max-width:170px;flex:1 1 170px"><label for="pf-dob">DOB</label><input id="pf-dob" class="input" type="date" aria-label="DOB" placeholder="YYYY-MM-DD"></div>
      <div style="max-width:240px;flex:1 1 240px"><label for="pf-pos">Position(s)</label><input id="pf-pos" class="input" placeholder="e.g., SS, 3B, OF"></div>
      <div style="max-width:90px;flex:1 1 90px"><label for="pf-num">#</label><input id="pf-num" class="input" type="number" placeholder="#"></div>
    </div>
    <div class="row">
      <div style="max-width:180px;flex:1 1 180px"><label for="pf-nsa">NSA rank</label><input id="pf-nsa" class="input" placeholder="NSA"></div>
      <div style="max-width:180px;flex:1 1 180px"><label for="pf-spn">SPN rank</label><input id="pf-spn" class="input" placeholder="SPN"></div>
      <button id="btn-add-player" class="btn" type="button">Add New Player</button>
      <span id="pf-err" class="small bad"></span>
    </div>

    <div class="hr"></div>

    <!-- SEARCH EXISTING -->
    <div class="row">
      <div style="max-width:360px;flex:1 1 360px"><label for="srch-name">Search existing players</label><input id="srch-name" class="input" placeholder="type a name…"></div>
      <div style="max-width:180px;flex:1 1 180px"><label for="srch-dob">DOB (optional)</label><input id="srch-dob" class="input" type="date"></div>
      <div style="max-width:120px;flex:1 1 120px"><label for="srch-num"># for team</label><input id="srch-num" class="input" type="number" placeholder="#"></div>
      <div style="max-width:220px;flex:1 1 220px"><label for="srch-pos">Position(s) for team</label><input id="srch-pos" class="input" placeholder="e.g., OF"></div>
      <button id="btn-search" class="btn" type="button" style="align-self:flex-end">Search</button>
    </div>
    <div id="srch-results" class="small" style="margin-top:6px"></div>

    <div id="roster-count" class="small" style="margin-top:10px"></div>
    <div class="scroll roster"><table class="table" id="tbl-roster"></table></div>
  </section>

  <!-- SCHEDULER -->
  <section id="sec-schedule" class="card hidden">
    <h2>3) Scheduler</h2>
    <div class="row">
      <input id="sch-date" class="input" type="date" style="max-width:170px"/>
      <input id="sch-time" class="input" type="time" style="max-width:130px"/>
      <input id="sch-field" class="input" placeholder="Field" style="max-width:180px"/>
      <input id="sch-comp" class="input" placeholder="League/Tournament" style="max-width:220px"/>
    </div>
    <div class="row">
      <input id="sch-home" class="input" placeholder="Home team" style="max-width:220px"/>
      <input id="sch-away" class="input" placeholder="Away team" style="max-width:220px"/>
      <button id="btn-sch-add" class="btn" type="button">Add game</button>
    </div>
  </section>

  <!-- CALENDAR (click a game to open tracker) -->
  <section id="sec-calendar" class="card hidden">
    <h2>4) Calendar</h2>
    <div class="cal-header">
      <button id="prev-month" class="btn outline small" type="button">◀</button>
      <h3 id="cal-title" style="margin:0 10px"></h3>
      <button id="next-month" class="btn outline small" type="button">▶</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </section>

  <!-- STATS -->
  <section id="sec-stats" class="card hidden">
    <h2>5) Player stats (global)</h2>
    <div class="scroll stats">
      <table class="table sortable" id="tbl-stats"></table>
    </div>
    <p class="small">Totals come from the player's global profile (across all teams).</p>
  </section>

  <!-- GAME TRACKER -->
  <section id="sec-game" class="card hidden">
    <h2>6) Game tracker</h2>

    <!-- Score bug -->
    <div class="scorebug" id="scorebug" style="display:none">
      <span id="bug-opp" class="tag">vs ?</span>
      <span id="bug-score" class="tag">0–0</span>
      <span id="bug-inning" class="tag">Top 1 • 0 out</span>
    </div>

    <div class="row" style="margin-top:8px">
      <select id="sel-side" class="input" style="max-width:140px">
        <option value="home">Home batting</option>
        <option value="away">Away batting</option>
      </select>
      <select id="sel-batter" class="input" style="max-width:280px"></select>
      <button id="btn-advance" class="btn outline" type="button" title="Advance batter index by 1">Next batter</button>
      <span class="small">Click on the diamond to start a play.</span>
    </div>

    <div id="diamond-wrap" class="row" style="margin-top:8px">
      <!-- Diamond SVG -->
      <svg id="diamond" width="360" height="360" viewBox="0 0 100 100" aria-label="Hit location">
        <rect x="0" y="0" width="100" height="100" fill="#0b1326" rx="6" ry="6" />
        <!-- outfield arcs -->
        <circle cx="50" cy="70" r="28" fill="#0e1630" stroke="#1f2937"/>
        <circle cx="50" cy="70" r="18" fill="#0b1326" stroke="#1f2937"/>
        <!-- infield diamond -->
        <polygon points="50,40 70,60 50,80 30,60" fill="#0e1630" stroke="#1f2937"/>
        <!-- bases -->
        <rect x="48" y="78" width="4" height="4" fill="#cbd5e1" transform="rotate(45 50 80)"/>
        <rect x="68" y="58" width="4" height="4" fill="#cbd5e1" transform="rotate(45 70 60)"/>
        <rect x="48" y="38" width="4" height="4" fill="#cbd5e1" transform="rotate(45 50 40)"/>
        <rect x="28" y="58" width="4" height="4" fill="#cbd5e1" transform="rotate(45 30 60)"/>
        <!-- label -->
        <text x="50" y="14" text-anchor="middle" font-size="6" fill="#94a3b8">Click where the ball landed</text>
      </svg>

      <!-- Bases + Runners -->
      <div>
        <div class="small" style="margin-bottom:6px">Runners (click to select, then click a base)</div>
        <div class="runners" id="runner-chips"></div>

        <div class="hr"></div>
        <div class="small" style="margin-bottom:6px">Bases</div>
        <div class="basegrid">
          <div></div>
          <div class="base" data-base="2B"><b>2B</b><span class="who" id="who-2B">—</span></div>
          <div></div>
          <div class="base" data-base="3B"><b>3B</b><span class="who" id="who-3B">—</span></div>
          <div class="base" data-base="HOME"><b>Home (score)</b><span class="who" id="who-H">—</span></div>
          <div class="base" data-base="1B"><b>1B</b><span class="who" id="who-1B">—</span></div>
        </div>
        <div id="base-msg" class="small" style="margin-top:6px"></div>

        <div class="hr"></div>
        <button id="btn-save-play" class="btn" type="button">Save play</button>
        <button id="btn-undo" class="btn outline" type="button">Undo last</button>
      </div>
    </div>

    <div class="hr"></div>
    <h3>Box score</h3>
    <div id="boxscore" class="scroll" style="max-height:40vh"></div>
  </section>
</main>

<!-- Result modal -->
<div id="modal">
  <div class="modal-card">
    <h3 style="margin-top:0">Play details</h3>
    <div class="row">
      <div style="max-width:220px;flex:1 1 220px">
        <label for="md-result">Result</label>
        <select id="md-result" class="input">
          <option value="1B">Single</option><option value="2B">Double</option><option value="3B">Triple</option>
          <option value="HR">Home Run</option><option value="BB">Walk</option><option value="K">Strikeout</option>
          <option value="GO">Groundout</option><option value="FO">Flyout</option><option value="ROE">Reach on Error</option>
          <option value="FC">Fielder's Choice</option><option value="SAC">Sacrifice</option>
        </select>
      </div>
      <div style="max-width:180px;flex:1 1 180px">
        <label for="md-hard">Contact</label>
        <select id="md-hard" class="input"><option>Medium</option><option>Hard</option><option>Soft</option></select>
      </div>
    </div>
    <p class="small">Now place runners on the bases using the panel next to the diamond, then click <b>Save play</b>.</p>
    <div class="row" style="justify-content:flex-end">
      <button id="md-close" class="btn outline" type="button">Close</button>
    </div>
  </div>
</div>

<div id="debug">status: <span id="dbg-status">boot</span></div>

<!-- Firebase (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, updateDoc,
    getDocs, query, where, orderBy, startAt, endAt, limit, arrayUnion
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // === Your Firebase config ===
  const firebaseConfig = {
    apiKey: "AIzaSyD3uKx0mIPTMT0pkL1Dxi-cGZiEZoQG3AU",
    authDomain: "statsdonkey-c276c.firebaseapp.com",
    projectId: "statsdonkey-c276c",
    storageBucket: "statsdonkey-c276c.firebasestorage.app",
    messagingSenderId: "456849470787",
    appId: "1:456849470787:web:0479b3dc8ca976296c2bf6",
    measurementId: "G-T670NG1LYF"
  };

  const app = initializeApp(firebaseConfig);
  try { if (await analyticsSupported()) getAnalytics(app); } catch {}
  const db = getFirestore(app);

  // ---------- Utilities ----------
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const setDbg = s => { const el = $('#dbg-status'); if (el) el.textContent = s; };
  function show(e){e&&e.classList.remove('hidden')} function hide(e){e&&e.classList.add('hidden')}
  function nameNorm(first,last){ return `${(first||'').trim().toLowerCase()} ${(last||'').trim().toLowerCase()}`.trim(); }
  async function sha256Hex(text){ const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  async function teamIdHash(team, pass){ return sha256Hex((team||'').trim().toLowerCase() + '|' + (pass||'')); }
  async function playerIdFor(first,last,dob){ return sha256Hex(`${(first||'').trim().toLowerCase()}|${(last||'').trim().toLowerCase()}|${(dob||'').trim()}`); }

  // ---------- State ----------
  let teamDocId = null, unsubTeam = null, unsubGame = null;
  let data = { team:{ name:'', logo:'' }, roster:[], schedule:[], stats:{} };
  let calCurrent = new Date();
  const playerCache = new Map();
  let currentGameId = null, currentGame = null;
  let pending = { x:null, y:null, result:'1B', hard:'Medium', bases:{ first:null, second:null, third:null }, scored:[], batter:null };

  // ---------- Team realtime ----------
  function startTeamListener(){
    stopTeamListener();
    unsubTeam = onSnapshot(doc(db, "teams", teamDocId), async snap=>{
      if (snap.exists()){
        data = snap.data();
        await preloadRosterPlayers();
        hydrateUI();
      }
    });
  }
  function stopTeamListener(){ if (unsubTeam){ unsubTeam(); unsubTeam=null; } }
  async function saveTeamDoc(patch){ await setDoc(doc(db, "teams", teamDocId), patch?patch:data, { merge:true }); }
  async function ensureTeamSeed(team){
    const ref = doc(db, "teams", teamDocId);
    const snap = await getDoc(ref);
    if (!snap.exists()) await setDoc(ref, { team:{ name: team, logo:'' }, roster:[], schedule:[], stats:{} }, { merge:true });
    else if (!snap.data().team?.name) await setDoc(ref, { team:{ name: team } }, { merge:true });
  }
  async function preloadRosterPlayers(){
    const ids = Array.from(new Set((data.roster||[]).map(r=>r.playerId).filter(Boolean)));
    await Promise.all(ids.map(async id=>{
      if (playerCache.has(id)) return;
      const snap = await getDoc(doc(db, "players", id));
      if (snap.exists()) playerCache.set(id, snap.data());
    }));
  }

  // ---------- UI boot ----------
  (function initUI(){
    // login
    $('#btn-login').onclick = async ()=>{
      const team = $('#team-id').value.trim();
      const pass = $('#team-pass').value;
      const err = $('#login-error'); err.textContent='';
      if (!team || !pass){ err.textContent='Enter team and password.'; return; }
      try{
        teamDocId = await teamIdHash(team, pass);
        await ensureTeamSeed(team);
        route(true); startTeamListener();
        setDbg('authless:ok');
      }catch(e){ console.error(e); err.textContent='Login failed (config/rules).'; }
    };
    $('#btn-logout').onclick = ()=>{ stopTeamListener(); stopGameListener(); currentGameId=null; currentGame=null; route(false); };

    // roster
    $('#btn-add-player').onclick = onAddPlayer;
    $('#btn-search').onclick = onSearchPlayers;

    // scheduler
    $('#btn-sch-add').onclick = onAddSchedule;

    // calendar nav
    $('#prev-month').onclick = ()=>{ calCurrent=new Date(calCurrent.getFullYear(), calCurrent.getMonth()-1, 1); renderCalendar(); };
    $('#next-month').onclick = ()=>{ calCurrent=new Date(calCurrent.getFullYear(), calCurrent.getMonth()+1, 1); renderCalendar(); };

    // tracker controls
    $('#sel-side').onchange = populateBatterSelect;
    $('#btn-advance').onclick = advanceBatter;
    $('#btn-save-play').onclick = savePlay;
    $('#btn-undo').onclick = undoLast;

    // diamond click → open modal (result prompt)
    $('#diamond').addEventListener('click', (ev)=>{
      if(!currentGameId) return;
      const r = ev.currentTarget.getBoundingClientRect();
      pending.x = ((ev.clientX - r.left) / r.width).toFixed(3);
      pending.y = ((ev.clientY - r.top) / r.height).toFixed(3);
      // prime modal with defaults
      $('#md-result').value = '1B';
      $('#md-hard').value = 'Medium';
      pending.result = '1B';
      pending.hard = 'Medium';
      $('#modal').style.display='flex';
    });
    $('#md-result').onchange = ()=> pending.result = $('#md-result').value;
    $('#md-hard').onchange   = ()=> pending.hard   = $('#md-hard').value;
    $('#md-close').onclick   = ()=> $('#modal').style.display='none';

    // base pads + runner chips
    $$('.base').forEach(b=>{
      b.onclick = ()=> {
        const base = b.dataset.base;
        placeSelectedRunner(base);
      };
    });

    setDbg('ready');
  })();

  // ---------- Routing & hydrate ----------
  function route(on){
    if(!on){
      show($('#view-login'));
      ['sec-team','sec-roster','sec-schedule','sec-calendar','sec-stats','sec-game'].forEach(id=>hide($('#'+id)));
      $('#btn-logout').classList.add('hidden'); return;
    }
    hide($('#view-login'));
    ['sec-team','sec-roster','sec-schedule','sec-calendar','sec-stats','sec-game'].forEach(id=>show($('#'+id)));
    $('#btn-logout').classList.remove('hidden');
    hydrateUI();
  }
  function hydrateUI(){
    // team
    $('#team-name').value = data.team?.name || '';
    const im=$('#logo-preview'); im.src = data.team?.logo || ''; im.style.display = data.team?.logo ? 'block':'none';
    // roster + stats + cal
    renderRoster(); renderStats(); renderCalendar();
    // tracker
    updateScoreViews();
    populateBatterSelect();
    renderBasesAndRunners();
    listGamesSelect(); // helpful if you still want to load from dropdown (optional)
  }

  // ---------- Roster ----------
  async function onAddPlayer(){
    $('#pf-err').textContent='';
    const first=$('#pf-first').value.trim(), last=$('#pf-last').value.trim();
    const dob=$('#pf-dob').value; const positions=$('#pf-pos').value.split(/\s*,\s*/).filter(Boolean);
    const number=$('#pf-num').value?Number($('#pf-num').value):undefined;
    const nsa=$('#pf-nsa').value.trim(), spn=$('#pf-spn').value.trim();
    if(!first || !last || !dob){ $('#pf-err').textContent='First, Last, and DOB are required.'; return; }
    try{
      const pid = await playerIdFor(first,last,dob);
      if ((data.roster||[]).some(r=>r.playerId===pid)){ $('#pf-err').textContent='Player already on this roster.'; return; }
      const pRef = doc(db,"players",pid); const pSnap=await getDoc(pRef);
      if (!pSnap.exists()){
        await setDoc(pRef,{
          first,last,dob,nameNorm:nameNorm(first,last),ranks:{nsa,spn},
          stats:{PA:0,AB:0,H:0,"1B":0,"2B":0,"3B":0,HR:0,BB:0,K:0,AVG:"0.000",OBP:"0.000",SLG:"0.000",OPS:"0.000"},
          createdAt:new Date().toISOString()
        },{merge:true});
      }else{
        const cur=pSnap.data()||{}; const ranks={...(cur.ranks||{})}; if(nsa)ranks.nsa=nsa; if(spn)ranks.spn=spn;
        await setDoc(pRef,{ranks},{merge:true});
      }
      playerCache.set(pid,(await getDoc(pRef)).data());
      const roster=[...(data.roster||[]), { playerId:pid, first,last,dob, number, positions, ranks:{nsa,spn} }];
      await saveTeamDoc({ roster });
      ['pf-first','pf-last','pf-dob','pf-pos','pf-num','pf-nsa','pf-spn'].forEach(id=>{ const el=$('#'+id); if(el) el.value=''; });
    }catch(e){ console.error(e); $('#pf-err').textContent='Add failed.'; }
  }
  async function onSearchPlayers(){
    const term=$('#srch-name').value.trim().toLowerCase(); const dob=$('#srch-dob').value; const out=$('#srch-results'); out.innerHTML='';
    if(!term){ out.textContent='Enter a name to search.'; return; }
    try{
      const qy=query(collection(db,"players"), orderBy('nameNorm'), startAt(term), endAt(term+'\uf8ff'), limit(25));
      const snap=await getDocs(qy); let list=snap.docs.map(d=>({id:d.id,...d.data()})); if(dob) list=list.filter(r=>(r.dob||'')===dob);
      if(!list.length){ out.textContent='No matches.'; return; }
      const numDefault=$('#srch-num').value?Number($('#srch-num').value):undefined;
      const posDefault=$('#srch-pos').value.split(/\s*,\s*/).filter(Boolean);
      const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='6px 0';
      list.forEach(r=>{
        const li=document.createElement('li'); li.style.marginBottom='6px';
        const already=(data.roster||[]).some(x=>x.playerId===r.id);
        li.innerHTML=`
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div><b>${r.first||''} ${r.last||''}</b> — DOB: ${r.dob||''}</div>
            <div class="small">NSA: ${r.ranks?.nsa||'-'} | SPN: ${r.ranks?.spn||'-'}</div>
            ${already?'<span class="small" style="color:#34d399">Already on roster</span>':'<button class="btn small" data-add="'+r.id+'">Add to team</button>'}
          </div>`;
        ul.appendChild(li);
      });
      out.appendChild(ul);
      out.querySelectorAll('button[data-add]').forEach(btn=>{
        btn.onclick=async()=>{
          const pid=btn.getAttribute('data-add'); if((data.roster||[]).some(x=>x.playerId===pid)) return;
          const pSnap=await getDoc(doc(db,"players",pid)); if(!pSnap.exists()) return;
          const p=pSnap.data();
          const roster=[...(data.roster||[]), { playerId:pid, first:p.first||'', last:p.last||'', dob:p.dob||'', number:numDefault, positions:posDefault, ranks:{nsa:p.ranks?.nsa||'', spn:p.ranks?.spn||''} }];
          await saveTeamDoc({ roster }); playerCache.set(pid,p);
          btn.replaceWith((()=>{const t=document.createElement('span'); t.className='small'; t.style.color='#34d399'; t.textContent='Added'; return t; })());
        };
      });
    }catch(e){ console.error(e); out.textContent='Search failed.'; }
  }
  function renderRoster(){
    const rows=(data.roster||[]).map(p=>`<tr>
      <td>${p.first} ${p.last}</td><td>${p.number||''}</td><td>${(p.positions||[]).join(', ')}</td>
      <td>${p.dob||''}</td><td>${p.ranks?.nsa||''}</td><td>${p.ranks?.spn||''}</td>
      <td class="small">${p.playerId}</td>`).join('');
    $('#roster-count').textContent = data.roster?.length ? (data.roster.length + ' players') : 'No players';
    $('#tbl-roster').innerHTML='<thead><tr><th>Player</th><th>#</th><th>Positions</th><th>DOB</th><th>NSA</th><th>SPN</th><th>ID</th></tr></thead><tbody>'+rows+'</tbody>';
  }

  // ---------- Scheduler & Calendar ----------
  async function onAddSchedule(){
    const date=$('#sch-date').value, time=$('#sch-time').value, field=$('#sch-field').value.trim(), comp=$('#sch-comp').value.trim();
    const home=$('#sch-home').value.trim(), away=$('#sch-away').value.trim();
    if(!date || !home || !away) return alert('Date, Home, Away required');
    const id=(crypto&&crypto.randomUUID)?crypto.randomUUID():String(Date.now());
    const schedule=[...(data.schedule||[]), { id, date, time, field, comp, home, away }];
    await saveTeamDoc({ schedule });
    $('#sch-time').value=''; $('#sch-field').value=''; $('#sch-comp').value='';
    renderCalendar();
  }

  function renderCalendar(){
    const m0=new Date(calCurrent.getFullYear(),calCurrent.getMonth(),1);
    const m1=new Date(calCurrent.getFullYear(),calCurrent.getMonth()+1,0);
    $('#cal-title').textContent=m0.toLocaleString(undefined,{month:'long',year:'numeric'});
    const first=m0.getDay(),days=m1.getDate(); const grid=$('#cal-grid'); grid.innerHTML='';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{const h=document.createElement('div'); h.className='cell head'; h.textContent=d; grid.appendChild(h);});
    for(let i=0;i<first;i++){const b=document.createElement('div'); b.className='cell blank'; grid.appendChild(b);}
    for(let day=1; day<=days; day++){
      const cell=document.createElement('div'); cell.className='cell';
      const ds=`${m0.getFullYear()}-${String(m0.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const head=document.createElement('div'); head.className='date'; head.textContent=day; cell.appendChild(head);
      const ul=document.createElement('ul'); ul.className='events';
      (data.schedule||[]).filter(g=>String(g.date)===ds).forEach(g=>{
        const li=document.createElement('li');
        li.textContent = `${g.time||''} ${g.home||'Home'} vs ${g.away||'Away'}${g.field?(' @ '+g.field):''}${g.comp?(' — '+g.comp):''}`.trim();
        li.dataset.sid = g.id;
        li.onclick = ()=> openTrackerFromSchedule(g, ds);
        ul.appendChild(li);
      });
      cell.appendChild(ul); grid.appendChild(cell);
    }
  }

  async function openTrackerFromSchedule(g, dateStr){
    const our = data.team?.name?.trim() || '';
    let isHome = true, opponent = g.away || 'Opponent';
    if (g.home?.trim() === our){ isHome=true; opponent = g.away||'Opponent'; }
    else if (g.away?.trim() === our){ isHome=false; opponent = g.home||'Opponent'; }
    // find or create game by date + opponent
    const sub = collection(doc(db,"teams",teamDocId),"games");
    // Query by date only (to avoid composite index), then filter on opponent in JS
    const qy = query(sub, where('meta.date','==', dateStr), limit(10));
    const snap = await getDocs(qy);
    let found = null; snap.forEach(d => { const x=d.data(); if ((x.meta?.opponent||'')===opponent) found = { id:d.id, data:x }; });
    if (found){ startGameListener(found.id); }
    else {
      const id = Date.now().toString(36);
      const def = { P:null,C:null,'1B':null,'2B':null,'3B':null,SS:null,LF:null,LCF:null,RCF:null,RF:null };
      const seed = {
        meta:{ date:dateStr, opponent, isHome, status:'pregame', createdAt:new Date().toISOString() },
        home:{ lineup:(data.roster||[]).slice(0,10).map(r=>r.playerId), defense:{...def}, batterIndex:0, name:data.team?.name||'Home' },
        away:{ roster:[], lineup:[], defense:{...def}, batterIndex:0, name:opponent },
        inning:{ half:'top', number:1, outs:0 },
        bases:{ first:null, second:null, third:null },
        score:{ home:0, away:0, byInning:{} },
        plays:[]
      };
      await setDoc(doc(db,"teams",teamDocId,"games",id), seed);
      startGameListener(id);
    }
    // route to tracker view
    document.getElementById('sec-game').scrollIntoView({behavior:'smooth'});
  }

  // ---------- Games list (optional helper) ----------
  async function listGamesSelect(){
    const selSide = $('#sel-side'); // noop, just to ensure present
    // no dropdown here; calendar is now the entrypoint
  }

  function stopGameListener(){ if (unsubGame){ unsubGame(); unsubGame=null; } }
  function startGameListener(gameId){
    stopGameListener();
    const ref=doc(db,"teams",teamDocId,"games",gameId);
    unsubGame=onSnapshot(ref,snap=>{
      if(!snap.exists()) return;
      currentGame=snap.data(); currentGameId=gameId;
      if (!currentGame.bases) currentGame.bases={ first:null, second:null, third:null };
      $('#scorebug').style.display='inline-flex';
      updateScoreViews();
      populateBatterSelect();
      renderBasesAndRunners();
    });
  }

  // ---------- Tracker helpers ----------
  function getHomeName(pid){
    const r=(data.roster||[]).find(x=>x.playerId===pid);
    return r ? `${r.first||''} ${r.last||''}`.trim() : pid;
  }
  function nameForId(id){ return getHomeName(id); } // away uses plain text ids

  function populateBatterSelect(){
    if(!currentGame) return;
    const side = currentGame.inning?.half==='top' ? 'away' : 'home';
    $('#sel-side').value = side;
    const sel=$('#sel-batter'); sel.innerHTML='';
    const arr = currentGame[side]?.lineup || [];
    arr.forEach(pid=>{
      const opt=document.createElement('option');
      opt.value=pid; opt.textContent = (side==='home') ? getHomeName(pid) : pid;
      sel.appendChild(opt);
    });
    const idx = currentGame[side]?.batterIndex || 0;
    sel.selectedIndex = (arr.length? (idx%arr.length) : -1);
  }
  async function advanceBatter(){
    if(!currentGameId) return;
    const side=$('#sel-side').value;
    const len = (currentGame?.[side]?.lineup||[]).length;
    const next = len ? (((currentGame?.[side]?.batterIndex||0)+1)%len) : 0;
    await setDoc(doc(db,"teams",teamDocId,"games",currentGameId), { [side]:{ ...(currentGame?.[side]||{}), batterIndex: next } }, {merge:true});
  }

  function renderBasesAndRunners(){
    if(!currentGame) return;
    // bases view
    const b=currentGame.bases||{first:null,second:null,third:null};
    $('#who-1B').textContent = b.first ? nameForId(b.first) : '—';
    $('#who-2B').textContent = b.second? nameForId(b.second): '—';
    $('#who-3B').textContent = b.third ? nameForId(b.third) : '—';
    $('#who-H').textContent   = '—';

    // runner chips = existing base occupants + batter
    const chips = [];
    if (b.first) chips.push({id:b.first, label:nameForId(b.first)});
    if (b.second)chips.push({id:b.second,label:nameForId(b.second)});
    if (b.third) chips.push({id:b.third, label:nameForId(b.third)});
    const batterId = $('#sel-batter').value || 'Batter';
    chips.push({id:batterId,label:(currentGame.inning?.half==='top' ? batterId : getHomeName(batterId)) || 'Batter'});

    const host=$('#runner-chips'); host.innerHTML='';
    chips.forEach(c=>{
      const el=document.createElement('div'); el.className='runner'; el.textContent=c.label; el.dataset.pid=c.id;
      el.onclick=()=>{ $$('.runner').forEach(x=>x.classList.remove('sel')); el.classList.add('sel'); host.dataset.sel = c.id; $('#base-msg').textContent='Selected: '+c.label; };
      host.appendChild(el);
    });
  }

  function placeSelectedRunner(base){
    const pid = $('#runner-chips').dataset.sel; if(!pid){ $('#base-msg').textContent='Select a runner first'; return; }
    // update pending bases map for this play (work on a temp copy seeded from current bases)
    if (!pending.bases) pending.bases={ first:null, second:null, third:null };
    // remove pid from all bases first
    for (const k of ['first','second','third']) if (pending.bases[k]===pid) pending.bases[k]=null;
    // place
    if (base==='1B') pending.bases.first = pid;
    else if (base==='2B') pending.bases.second = pid;
    else if (base==='3B') pending.bases.third = pid;
    else if (base==='HOME') {
      // mark as scored (remove from bases, count run)
      if (!pending.scored) pending.scored=[];
      if (!pending.scored.includes(pid)) pending.scored.push(pid);
      for (const k of ['first','second','third']) if (pending.bases[k]===pid) pending.bases[k]=null;
      $('#who-H').textContent='Scored: '+ (currentGame.inning?.half==='top' ? pid : getHomeName(pid));
      $('#base-msg').textContent = 'Marked run';
      return;
    }
    // reflect in UI preview
    const b = Object.assign({ first:null,second:null,third:null }, currentGame.bases, pending.bases);
    $('#who-1B').textContent = b.first ? nameForId(b.first) : '—';
    $('#who-2B').textContent = b.second? nameForId(b.second): '—';
    $('#who-3B').textContent = b.third ? nameForId(b.third) : '—';
    $('#base-msg').textContent = 'Placed runner on '+base;
  }

  async function savePlay(){
    if(!currentGameId) return;
    // ensure modal was opened at least once for this play to set result/coords
    const side = $('#sel-side').value;
    const batter = $('#sel-batter').value || 'Unknown';
    // derive basesAfter: if user didn’t place anything, keep current bases; else merge
    const after = Object.assign({ first:null,second:null,third:null }, currentGame.bases, pending.bases||{});
    const runs = (pending.scored||[]).length;

    const play = {
      ts: new Date().toISOString(),
      batting: side,
      batter,
      result: pending.result || '1B',
      hard: pending.hard || 'Medium',
      loc: { x: pending.x, y: pending.y },
      basesAfter: after,
      runs,
      inning: currentGame.inning?.number||1,
      half: currentGame.inning?.half||'top'
    };
    const ref=doc(db,"teams",teamDocId,"games",currentGameId);
    await updateDoc(ref, { plays: arrayUnion(play), bases: after });

    // advance batter index
    const len = (currentGame?.[side]?.lineup||[]).length||0;
    const next = len ? (((currentGame?.[side]?.batterIndex||0)+1)%len) : 0;
    await setDoc(ref, { [side]:{ ...(currentGame?.[side]||{}), batterIndex: next } }, {merge:true});

    // reset pending + UI
    pending = { x:null, y:null, result:'1B', hard:'Medium', bases:{ first:null,second:null,third:null }, scored:[], batter:null };
    $('#modal').style.display='none';
    $('#base-msg').textContent='Play saved';
  }

  async function undoLast(){
    if(!currentGameId) return; const ref=doc(db,"teams",teamDocId,"games",currentGameId);
    const snap=await getDoc(ref); if(!snap.exists()) return;
    const plays=[...(snap.data().plays||[])]; const last=plays.pop();
    await setDoc(ref,{plays},{merge:true});
    // restore previous bases if we have a prior play; else clear
    if (plays.length){
      const prev = plays[plays.length-1];
      const b = prev.basesAfter || { first:null,second:null,third:null };
      await setDoc(ref,{bases:b},{merge:true});
    } else {
      await setDoc(ref,{bases:{ first:null,second:null,third:null }},{merge:true});
    }
  }

  // ---------- Score & Box ----------
  function computeScore(plays){
    const score={home:0,away:0, byInning:{}};
    (plays||[]).forEach(p=>{
      const runs = Number(p.runs||0)||0;
      score[p.batting]+=runs;
      const inn=p.inning||1;
      if(!score.byInning[inn]) score.byInning[inn]={home:0,away:0};
      score.byInning[inn][p.batting]+=runs;
    });
    return score;
  }
  function updateScoreViews(){
    if(!currentGame) return;
    const score = computeScore(currentGame.plays||[]);
    const opp = currentGame.meta?.opponent||'?';
    const half = currentGame.inning?.half==='top'?'Top':'Bot';
    const outs = currentGame.inning?.outs||0;
    $('#bug-opp').textContent = (currentGame.meta?.isHome ? `vs ${opp}` : `@ ${opp}`);
    $('#bug-score').textContent = `${score.home}–${score.away}`;
    $('#bug-inning').textContent = `${half} ${currentGame.inning?.number||1} • ${outs} out`;

    const maxInning = Math.max( ...[1, ...Object.keys(score.byInning).map(n=>Number(n)||1) ] );
    let html = '<table class="table"><thead><tr><th></th>';
    for(let i=1;i<=maxInning;i++) html += `<th>${i}</th>`;
    html += '<th>R</th></tr></thead><tbody>';
    const row = (name,side)=>{ let t=`<tr><td>${name}</td>`; for(let i=1;i<=maxInning;i++){ t+=`<td>${(score.byInning[i]?.[side]||0)}</td>`; } t+=`<td>${score[side]}</td></tr>`; return t; };
    html += row(currentGame.home?.name||'Home','home');
    html += row(currentGame.away?.name||'Away','away');
    html += '</tbody></table>';
    $('#boxscore').innerHTML = html;
  }

  // ---------- Stats ----------
  function computeStatsRows(){
    return (data.roster||[]).map(r=>{
      const g=playerCache.get(r.playerId)||{}; const s=g.stats||{};
      return { Player:`${r.first} ${r.last}`.trim(), PA:s.PA||0, AB:s.AB||0, H:s.H||0, '1B':s['1B']||0, '2B':s['2B']||0, '3B':s['3B']||0, HR:s.HR||0, BB:s.BB||0, K:s.K||0, AVG:s.AVG||'0.000', OBP:s.OBP||'0.000', SLG:s.SLG||'0.000', OPS:s.OPS||'0.000' };
    });
  }
  let sortKey='Player', sortDir='asc';
  function renderStats(){
    let rows=computeStatsRows();
    rows.sort((a,b)=>{const A=a[sortKey],B=b[sortKey];const num=!isNaN(parseFloat(A))&&!isNaN(parseFloat(B));return (sortDir==='asc'?1:-1)*(num?(parseFloat(A)-parseFloat(B)):String(A).localeCompare(String(B)));});
    const headers=['Player','PA','AB','H','1B','2B','3B','HR','BB','K','AVG','OBP','SLG','OPS'];
    const thead='<thead><tr>'+headers.map(h=>`<th class="sort" data-key="${h}">${h}</th>`).join('')+'</tr></thead>';
    const tbody='<tbody>'+rows.map(r=>'<tr>'+headers.map(h=>`<td>${r[h]}</td>`).join('')+'</tr>').join('')+'</tbody>';
    $('#tbl-stats').innerHTML=thead+tbody;
    $$('#tbl-stats th.sort').forEach(th=>th.addEventListener('click',()=>{const key=th.dataset.key;if(sortKey===key) sortDir=(sortDir==='asc'?'desc':'asc'); else{sortKey=key;sortDir='asc';} renderStats();}));
  }

  // ---------- Boot ----------
  setDbg('ready');
</script>

<noscript><div style="background:#fee2e2;color:#7f1d1d;padding:12px;margin:12px;border-radius:8px">
JavaScript is disabled. Enable it to use StatsDonkey.
</div></noscript>
</body>
</html>
