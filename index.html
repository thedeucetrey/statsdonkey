<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StatsDonkey — R11</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--fg:#e5e7eb;--mut:#94a3b8;--acc:#4ade80;--line:#1f2937;--pad:14px;--rad:16px}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:var(--pad);box-shadow:0 8px 24px rgba(0,0,0,.25);margin-bottom:var(--pad)}
.hidden{display:none!important} .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
label{font-size:12px;color:#cbd5e1;display:block;margin-bottom:4px}
.input,select,textarea{width:100%;background:#0b1220;color:var(--fg);border:1px solid #334155;border-radius:12px;padding:12px}
textarea{min-height:80px}
.btn{background:var(--acc);color:#06220f;border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
.btn.outline{background:transparent;color:var(--acc);border:1px solid var(--acc)} .btn.small{padding:8px 10px;font-size:12px}
.small{font-size:12px;color:var(--mut)} .bad{color:#f87171}.good{color:#34d399}
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
.table thead th{position:sticky;top:0;background:var(--card);z-index:1}
.table th.sort{cursor:pointer}
.scroll{overflow:auto;border:1px solid var(--line);border-radius:12px;padding:6px}
.scroll.roster{max-height:50vh} .scroll.stats{max-height:50vh}
nav{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.9);border-bottom:1px solid var(--line);backdrop-filter:blur(6px)}
nav .wrap{display:flex;align-items:center;gap:10px;max-width:1100px;margin:0 auto;padding:10px 16px}
.brand{font-weight:800;color:#4ade80} .spacer{flex:1}
#bug{display:flex;gap:12px;align-items:center}
#bug .pill{background:#0b1326;border:1px solid #1f2937;border-radius:999px;padding:4px 10px;font-weight:700}
#field{background:#08101f;border:1px solid #1f2937;border-radius:12px;aspect-ratio:1.4/1;position:relative}
#field svg{width:100%;height:100%}
#field .drop{position:absolute;transform:translate(-50%,-50%);min-width:110px}
.basepath{fill:#14532d} .infield{fill:#166534}
@media (max-width:740px){.container{padding:12px}}
</style>
</head>
<body>
<nav>
  <div class="wrap">
    <div class="brand">StatsDonkey</div>
    <div class="spacer"></div>
    <div id="bug" class="small">
      <span class="pill" id="bug-game">No game</span>
      <span class="pill" id="bug-inning">—</span>
      <span class="pill" id="bug-score">0–0</span>
      <span class="pill" id="bug-count">B0 S0 • 0 out</span>
      <span class="pill" id="bug-bases">Bases: ---</span>
      <span class="small">R11</span>
    </div>
    <button id="btn-logout" class="btn outline small hidden" type="button" style="margin-left:8px">Logout</button>
  </div>
</nav>

<main class="container">
  <!-- LOGIN -->
  <section id="view-login" class="card">
    <h2>Team Login</h2>
    <p class="small">Enter <b>Team</b> and <b>Password</b>. First login creates the team. Any device with the same team+password loads the same data.</p>
    <div class="row">
      <div>
        <label for="team-id">Team</label>
        <input id="team-id" class="input" placeholder="Argos" autocomplete="off" autocapitalize="none" spellcheck="false" style="max-width:280px"/>
      </div>
      <div>
        <label for="team-pass">Password</label>
        <input id="team-pass" class="input" type="password" placeholder="●●●●●●" autocomplete="new-password" style="max-width:220px"/>
      </div>
      <button id="btn-login" class="btn" type="button">Log in</button>
    </div>
    <div id="login-error" class="small bad" style="margin-top:6px"></div>
  </section>

  <!-- TEAM PROFILE -->
  <section id="sec-team" class="card hidden">
    <h2>1) Team profile</h2>
    <div class="row">
      <div style="min-width:260px;flex:1">
        <label for="team-name">Team name</label>
        <input id="team-name" class="input" placeholder="Team name"/>
      </div>
      <div style="min-width:260px;flex:1">
        <label for="team-logo">Logo</label>
        <input id="team-logo" type="file" accept="image/*" class="input"/>
      </div>
      <button id="btn-save-team" class="btn" type="button">Save profile</button>
    </div>
    <div class="small" style="margin-top:8px">Logo preview:</div>
    <img id="logo-preview" alt="logo" style="max-width:160px;max-height:160px;border:1px solid var(--line);border-radius:12px;display:none"/>
  </section>

  <!-- ROSTER -->
  <section id="sec-roster" class="card hidden">
    <h2>2) Roster</h2>
    <div class="row">
      <div><label for="pf-first">First</label><input id="pf-first" class="input" placeholder="First" style="max-width:160px"/></div>
      <div><label for="pf-last">Last</label><input id="pf-last" class="input" placeholder="Last" style="max-width:160px"/></div>
      <div><label for="pf-dob">DOB</label><input id="pf-dob" class="input" type="date" placeholder="YYYY-MM-DD" style="max-width:160px"/></div>
      <div><label for="pf-pos">Position(s)</label><input id="pf-pos" class="input" placeholder="SS, 3B, OF" style="max-width:220px"/></div>
      <div><label for="pf-num">#</label><input id="pf-num" class="input" type="number" placeholder="#" style="max-width:100px"/></div>
    </div>
    <div class="row">
      <div><label for="pf-nsa">NSA rank</label><input id="pf-nsa" class="input" placeholder="NSA rank" style="max-width:180px"/></div>
      <div><label for="pf-spn">SPN rank</label><input id="pf-spn" class="input" placeholder="SPN rank" style="max-width:180px"/></div>
      <button id="btn-add-player" class="btn" type="button">Add New Player</button>
      <span id="pf-err" class="small bad"></span>
    </div>

    <hr style="border-color:#1f2937;margin:14px 0;opacity:.6"/>

    <!-- Search existing global players -->
    <div class="row">
      <div style="flex:1 1 360px">
        <label for="srch-name">Search existing players by name</label>
        <input id="srch-name" class="input" placeholder="Type a name (prefix search)"/>
      </div>
      <div style="flex:0 1 180px">
        <label for="srch-dob">DOB (optional)</label>
        <input id="srch-dob" class="input" type="date" placeholder="YYYY-MM-DD"/>
      </div>
      <div style="flex:0 1 120px">
        <label for="srch-num"># (optional)</label>
        <input id="srch-num" class="input" type="number" placeholder="# for team"/>
      </div>
      <div style="flex:0 1 220px">
        <label for="srch-pos">Positions (optional)</label>
        <input id="srch-pos" class="input" placeholder="SS,OF"/>
      </div>
      <button id="btn-search" class="btn" type="button">Search</button>
    </div>
    <div id="srch-results" class="small" style="margin-top:6px"></div>

    <div id="roster-count" class="small" style="margin-top:10px"></div>
    <div class="scroll roster"><table class="table" id="tbl-roster"></table></div>
  </section>

  <!-- PRE-GAME: Lineup + Defense + Opponent -->
  <section id="sec-setup" class="card hidden">
    <h2>3) Game setup (lineups & defense)</h2>
    <div class="row">
      <div style="flex:1 1 220px"><label for="gs-date">Date</label><input id="gs-date" class="input" type="date"/></div>
      <div style="flex:1 1 140px"><label for="gs-time">Time</label><input id="gs-time" class="input" type="time"/></div>
      <div style="flex:1 1 200px"><label for="gs-field">Field</label><input id="gs-field" class="input" placeholder="Field"/></div>
      <div style="flex:1 1 220px"><label for="gs-comp">League/Tournament</label><input id="gs-comp" class="input" placeholder="League/Tournament"/></div>
      <div style="flex:0 0 120px"><label>Home?</label><select id="gs-home" class="input"><option value="true">We are HOME</option><option value="false">We are AWAY</option></select></div>
      <div style="flex:1 1 240px"><label for="gs-opponent">Opponent</label><input id="gs-opponent" class="input" placeholder="Opponent name"/></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="card" style="flex:1 1 420px">
        <h3 style="margin-top:0">Our lineup (1–12)</h3>
        <div id="our-lineup"></div>
      </div>
      <div class="card" style="flex:1 1 420px">
        <h3 style="margin-top:0">Opponent lineup (1–12)</h3>
        <div id="opp-lineup"></div>
        <div class="row" style="margin-top:8px">
          <div><label for="opp-first">First</label><input id="opp-first" class="input" style="max-width:140px"/></div>
          <div><label for="opp-last">Last</label><input id="opp-last" class="input" style="max-width:140px"/></div>
          <div><label for="opp-num">#</label><input id="opp-num" class="input" type="number" style="max-width:80px"/></div>
          <button id="btn-opp-add" class="btn" type="button">Add Opponent</button>
        </div>
        <div id="opp-roster" class="small" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="card" style="flex:1 1 380px">
        <h3 style="margin-top:0">Defense (our team)</h3>
        <div id="defense-grid"></div>
      </div>
      <div class="card" style="flex:1 1 420px">
        <h3 style="margin-top:0">Field diagram</h3>
        <div id="field">
          <!-- simple diamond -->
          <svg viewBox="0 0 100 70" preserveAspectRatio="xMidYMid meet">
            <rect x="0" y="0" width="100" height="70" fill="#0b1220"/>
            <polygon class="basepath" points="50,10 85,35 50,60 15,35"/>
            <polygon class="infield"  points="50,18 77,35 50,52 23,35"/>
            <!-- bases -->
            <circle cx="50" cy="18" r="1.6" fill="#e5e7eb"/>
            <circle cx="77" cy="35" r="1.6" fill="#e5e7eb"/>
            <circle cx="23" cy="35" r="1.6" fill="#e5e7eb"/>
            <circle cx="50" cy="52" r="1.6" fill="#e5e7eb"/>
          </svg>
          <!-- drop zones / labels -->
          <div class="drop" style="left:50%;top:64%" data-pos="C"></div>
          <div class="drop" style="left:40%;top:56%" data-pos="P"></div>
          <div class="drop" style="left:33%;top:45%" data-pos="1B"></div>
          <div class="drop" style="left:67%;top:45%" data-pos="3B"></div>
          <div class="drop" style="left:50%;top:40%" data-pos="2B"></div>
          <div class="drop" style="left:56%;top:48%" data-pos="SS"></div>
          <div class="drop" style="left:15%;top:20%" data-pos="LF"></div>
          <div class="drop" style="left:50%;top:16%" data-pos="CF"></div>
          <div class="drop" style="left:85%;top:20%" data-pos="RF"></div>
          <div class="drop" style="left:68%;top:14%" data-pos="ROV"></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btn-create-game" class="btn" type="button">Create / Update Game</button>
      <span class="small" id="setup-msg"></span>
    </div>
  </section>

  <!-- GAME TRACKER -->
  <section id="sec-game" class="card hidden">
    <h2>4) Live game</h2>
    <div class="row">
      <div class="card" style="flex:2 1 460px">
        <h3 style="margin-top:0">At-bat</h3>
        <div class="row">
          <div style="flex:1 1 240px">
            <div class="small">Batter</div>
            <div id="gt-batter" style="font-weight:800"></div>
            <div class="small" id="gt-ondeck"></div>
          </div>
          <div style="flex:1 1 200px">
            <div class="small">Count</div>
            <div><span id="gt-count">B0 S0</span> • <span id="gt-outs">0 out</span></div>
            <div class="row" style="margin-top:6px">
              <button class="btn small" id="btn-ball">Ball</button>
              <button class="btn small" id="btn-strike">Strike</button>
              <button class="btn small outline" id="btn-reset-count">Reset</button>
            </div>
          </div>
          <div style="flex:1 1 220px">
            <div class="small">Bases</div>
            <div id="gt-bases">--- </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" data-res="1B">1B</button>
          <button class="btn" data-res="2B">2B</button>
          <button class="btn" data-res="3B">3B</button>
          <button class="btn" data-res="HR">HR</button>
          <button class="btn" data-res="BB">BB</button>
          <button class="btn" data-res="K">K</button>
          <button class="btn" data-res="OUT">Out</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1 1 220px">
            <label for="gt-defense">Defense note (e.g., 6-3, DP)</label>
            <input id="gt-defense" class="input" placeholder="e.g., 6-3, 4-6-3 DP"/>
          </div>
          <div style="flex:1 1 220px">
            <label for="gt-runners">Runner advances (override)</label>
            <input id="gt-runners" class="input" placeholder="e.g., 1->3, 2->H, B->1"/>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="small">Spray chart: click where the ball landed</div>
          <div id="spray" style="background:#08101f;border:1px solid #1f2937;border-radius:12px;aspect-ratio:1.4/1;position:relative">
            <svg viewBox="0 0 100 70"><rect x="0" y="0" width="100" height="70" fill="#0b1220"/><polygon class="basepath" points="50,10 85,35 50,60 15,35"/><polygon class="infield"  points="50,18 77,35 50,52 23,35"/><circle cx="50" cy="18" r="1.6" fill="#e5e7eb"/><circle cx="77" cy="35" r="1.6" fill="#e5e7eb"/><circle cx="23" cy="35" r="1.6" fill="#e5e7eb"/><circle cx="50" cy="52" r="1.6" fill="#e5e7eb"/></svg>
            <div id="spray-dot" style="position:absolute;width:10px;height:10px;background:#4ade80;border-radius:50%;transform:translate(-50%,-50%);display:none"></div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btn-commit" class="btn" type="button">Commit play</button>
          <button id="btn-undo" class="btn outline" type="button">Undo last</button>
          <span id="gt-msg" class="small"></span>
        </div>
      </div>

      <div class="card" style="flex:1 1 300px">
        <h3 style="margin-top:0">Box score</h3>
        <div class="small" id="bx-meta"></div>
        <table class="table" id="bx-table"></table>
      </div>
    </div>
  </section>

  <!-- STATS -->
  <section id="sec-stats" class="card hidden">
    <h2>5) Player stats (global)</h2>
    <div class="scroll stats">
      <table class="table sortable" id="tbl-stats"></table>
    </div>
    <p class="small">Totals come from each player's global profile (across teams). The live logger will update these.</p>
  </section>
</main>

<div id="debug">status: <span id="dbg-status">boot</span></div>

<!-- Firebase modular ESM (NO auth) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, startAt, endAt, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // === Your Firebase config (same as before) ===
  const firebaseConfig = {
    apiKey: "AIzaSyD3uKx0mIPTMT0pkL1Dxi-cGZiEZoQG3AU",
    authDomain: "statsdonkey-c276c.firebaseapp.com",
    projectId: "statsdonkey-c276c",
    storageBucket: "statsdonkey-c276c.firebasestorage.app",
    messagingSenderId: "456849470787",
    appId: "1:456849470787:web:0479b3dc8ca976296c2bf6",
    measurementId: "G-T670NG1LYF"
  };

  const app = initializeApp(firebaseConfig);
  try{ if(await analyticsSupported()) getAnalytics(app); }catch{}
  const db = getFirestore(app);

  // ===== Utilities, globals
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const setDbg = s => { const el = $('#dbg-status'); if (el) el.textContent = s; };

  let teamDocId=null, unsubTeam=null, unsubGame=null;
  let data={ team:{name:'',logo:''}, roster:[], schedule:[], stats:{} };
  let playerCache=new Map();
  let currentGameId=null, game={}; // live game doc

  // Hash helpers
  async function sha256Hex(text){ const buf=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  async function teamIdHash(team, pass){ return sha256Hex((team||'').trim().toLowerCase() + '|' + (pass||'')); }
  async function playerIdFor(f,l,d){ return sha256Hex(`${(f||'').trim().toLowerCase()}|${(l||'').trim().toLowerCase()}|${(d||'').trim()}`); }

  function show(e){e&&e.classList.remove('hidden')} function hide(e){e&&e.classList.add('hidden')}

  // ===== Team doc listener
  function startTeamListener(){
    stopTeamListener();
    unsubTeam = onSnapshot(doc(db,'teams',teamDocId), async snap=>{
      if(snap.exists()){
        data = snap.data();
        await preloadRosterPlayers();
        hydrateBasics();
      }
    }, err=>console.error(err));
  }
  function stopTeamListener(){ if (unsubTeam){unsubTeam();unsubTeam=null;} }
  async function saveTeamDoc(patch){ await setDoc(doc(db,'teams',teamDocId), patch?patch:data, {merge:true}); }
  async function ensureTeamSeed(team){
    const ref=doc(db,'teams',teamDocId); const s=await getDoc(ref);
    if(!s.exists()) await setDoc(ref,{team:{name:team,logo:''}, roster:[], schedule:[], stats:{}}, {merge:true});
  }

  async function preloadRosterPlayers(){
    const ids=[...new Set((data.roster||[]).map(r=>r.playerId).filter(Boolean))];
    await Promise.all(ids.map(async id=>{ if(playerCache.has(id)) return; const s=await getDoc(doc(db,'players',id)); if(s.exists()) playerCache.set(id,s.data()); }));
  }

  // ===== Game doc listener
  function startGameListener(gameId){
    stopGameListener();
    currentGameId=gameId;
    const ref=doc(db,'teams',teamDocId,'games',gameId);
    unsubGame = onSnapshot(ref, snap=>{
      if(snap.exists()){
        game = snap.data();
        renderBug(); renderBox(); renderAtBat();
      }
    }, err=>console.error(err));
  }
  function stopGameListener(){ if (unsubGame){unsubGame();unsubGame=null;} }
  async function saveGame(patch){
    const ref=doc(db,'teams',teamDocId,'games',currentGameId);
    await setDoc(ref, patch?patch:game, {merge:true});
  }

  // ===== UI boot
  (function initUI(){
    // login
    $('#btn-login').onclick = async ()=>{
      const team=$('#team-id').value.trim(); const pass=$('#team-pass').value;
      const err=$('#login-error'); err.textContent='';
      if(!team||!pass){err.textContent='Enter team and password.';return;}
      try{
        teamDocId=await teamIdHash(team,pass);
        await ensureTeamSeed(team);
        route(true); startTeamListener();
        setDbg('ok');
      }catch(e){ err.textContent='Login failed.'; console.error(e); }
    };
    $('#btn-logout').onclick = ()=>{ stopTeamListener(); stopGameListener(); teamDocId=null; route(false); };

    // profile
    $('#btn-save-team').onclick = async ()=>{
      const name=$('#team-name').value.trim()||(data.team?.name||''); await saveTeamDoc({team:{...(data.team||{}), name}}); alert('Profile saved');
    };
    $('#team-logo').onchange = (ev)=>{
      const f=ev.target.files?.[0]; if(!f) return;
      const r=new FileReader(); r.onload=async()=>{ await saveTeamDoc({team:{...(data.team||{}), logo:r.result}}); }; r.readAsDataURL(f);
    };

    // roster add
    $('#btn-add-player').onclick = async ()=>{
      $('#pf-err').textContent='';
      const first=$('#pf-first').value.trim(), last=$('#pf-last').value.trim
